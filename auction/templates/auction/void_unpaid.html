<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Unpaid Transactions</title>
</head>
<body>
    <h1>Void Unpaid Transactions</h1>

    <form id="voidUnpaidForm" method="post">
        {% csrf_token %}
        <div>
            <label for="warehouseSelect">Select Warehouse:</label>
            <select name="warehouse" id="warehouseSelect" required>
                {% for warehouse in warehouses %}
                    <option value="{{ warehouse }}" {% if warehouse == default_warehouse %}selected{% endif %}>
                        {{ warehouse }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="auction_id">Auction ID:</label>
            <input type="text" id="auction_id" name="auction_id" required>
        </div>
        <div>
            <label>Upload to Airtable:</label>
            <input type="radio" id="upload_yes" name="upload_choice" value="1" required>
            <label for="upload_yes">Yes</label>
            <input type="radio" id="upload_no" name="upload_choice" value="0" required>
            <label for="upload_no">No</label>
        </div>
        {% if can_use_show_browser %}
        <div>
            <label for="show_browser">Show Browser:</label>
            <input type="checkbox" id="show_browser" name="show_browser">
        </div>
        {% endif %}
        <button type="submit">Void Unpaid Transactions</button>
    </form>

    <div id="result"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('voidUnpaidForm').addEventListener('submit', function(e) {
            e.preventDefault();
            voidUnpaid();
        });
    });

    function voidUnpaid() {
        console.log("voidUnpaid function called");
        const form = document.getElementById('voidUnpaidForm');
        const data = {
            warehouse: form.warehouse.value,
            auction_id: form.auction_id.value,
            upload_choice: parseInt(form.upload_choice.value),
            show_browser: form.show_browser ? form.show_browser.checked : false,
        };
        
        console.log("Sending data:", data);

        document.querySelector('button[type="submit"]').disabled = true;
        document.getElementById('result').textContent = 'Processing...';

        fetch('{% url "auction:void_unpaid" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => { throw new Error(data.error); });
            }
            return response.json();
        })
        .then(data => {
            console.log("Response data:", data);
            document.getElementById('result').textContent = "Success: " + data.message;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('result').textContent = "Error: " + error.message;
        })
        .finally(() => {
            document.querySelector('button[type="submit"]').disabled = false;
        });
    }
    </script>

    <p><a href="{% url 'auction:home' %}">Back to Home</a></p>
</body>
</html>