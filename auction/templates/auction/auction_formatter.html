<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction Formatter</title>
    <script>
        // Parse the auctions JSON data passed from the view
        const auctions = JSON.parse('{{ auctions|safe }}');

        function updateAuctionDropdown() {
            const warehouseSelect = document.getElementById('selected_warehouse');
            const auctionSelect = document.getElementById('auction_id');
            const selectedWarehouse = warehouseSelect.value;

            // Clear existing options
            auctionSelect.innerHTML = '<option value="">Select an auction</option>';

            // Filter auctions for the selected warehouse
            const filteredAuctions = auctions.filter(auction => auction.warehouse === selectedWarehouse);

            // Add new options
            filteredAuctions.forEach(auction => {
                const option = document.createElement('option');
                option.value = auction.id;
                option.textContent = `${auction.title} (${auction.id})`;
                auctionSelect.appendChild(option);
            });
        }

        // Call updateAuctionDropdown when the page loads to set initial state
        document.addEventListener('DOMContentLoaded', updateAuctionDropdown);

        function formatAuction(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const resultMessage = document.getElementById('result-message');
            const downloadButton = document.getElementById('download-csv');

            // Add the show_browser value to formData
            const showBrowser = document.getElementById('show_browser').checked;
            formData.append('show_browser', showBrowser ? '1' : '0');

            fetch('{% url "auction:auction_formatter" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                resultMessage.textContent = data.message;
                if (data.status === 'success' && data.show_download) {
                    showDownloadButton(data.auction_id);
                } else {
                    downloadButton.style.display = 'none';
                }
            })
            .catch(error => {
                resultMessage.textContent = 'An error occurred: ' + error;
                downloadButton.style.display = 'none';
            });
        }

        function showDownloadButton(auctionId) {
            const downloadButton = document.getElementById('download-csv');
            downloadButton.style.display = 'block';
            downloadButton.onclick = function() {
                window.location.href = '{% url "auction:download_formatted_csv" auction_id="0" %}'.replace('0', auctionId);
            };
        }
    </script>
</head>
<body>
    <h1>Auction Formatter</h1>
    <form method="post" onsubmit="formatAuction(event)">
        {% csrf_token %}
        <div>
            <label for="selected_warehouse">Selected Warehouse:</label>
            <select id="selected_warehouse" name="selected_warehouse" onchange="updateAuctionDropdown()">
                <option value="">Select a warehouse</option>
                {% for warehouse in warehouses %}
                    <option value="{{ warehouse }}">{{ warehouse }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="auction_id">Auction ID:</label>
            <select id="auction_id" name="auction_id" required>
                <option value="">Select an auction</option>
                <!-- Options will be populated dynamically by JavaScript -->
            </select>
        </div>
        <div>
            <label for="show_browser">Show Browser:</label>
            <input type="checkbox" id="show_browser" name="show_browser" value="1">
        </div>
        <button type="submit">Format Auction</button>
    </form>
    <div id="result-message"></div>
    <button id="download-csv" style="display: none;">Download CSV</button>
</body>
</html>